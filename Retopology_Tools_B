# ##### BEGIN GPL LICENSE BLOCK #####
#
#  This program is free software; you can redistribute it and/or
#  modify it under the terms of the GNU General Public License
#  as published by the Free Software Foundation; either version 2
#  of the License, or (at your option) any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software Foundation,
#  Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
#
# ##### END GPL LICENSE BLOCK #####

###############################################################################################################################################################################
#
# This B version of the retopology tool needs Iceking's Addon, Bsurfaces, Looptools and Auto mirror to work
# - Iceking's Addon > http://www.blenderartists.org/forum/showthread.php?343641-Iceking-s-Tools
# - Auto Mirror By Lapineige > http://le-terrier-de-lapineige.over-blog.com/2014/07/automirror-mon-add-on-pour-symetriser-vos-objets-rapidement.html
# - Bsurface 1.5 > http://www.blenderartists.org/forum/showthread.php?225190-Bsurfaces-v1-5&highlight=bsurface
#
###############################################################################################################################################################################



bl_info = {
    "name": "Retopology Tools",
    "author": "CÃ©dric Lepiller", "Gert De Roost for the Laprelax code" 
    "version": (0, 1, 0),
    "blender": (2, 7, 0),
    "location": "View 3D > Toolbar > Tools tab > Retopology (panel)",
    "description": "Tools for fast retopology",
    "category": "3D View"}

############### Operators

import bpy
import bmesh
from mathutils import *
import math

#Gstretch
class MeshGstretch(bpy.types.Operator):  
    bl_idname = "mesh.gstretch"  
    bl_label = "Mesh Gstretch"  
  
    def execute(self, context):
        bpy.ops.mesh.looptools_gstretch(conversion='limit_vertices', conversion_distance=0.1, conversion_max=32, conversion_min=8, conversion_vertices=32, delete_strokes=False, influence=100, lock_x=False, lock_y=False, lock_z=False, method='regular')
        bpy.ops.gpencil.active_frame_delete('INVOKE_REGION_WIN')
        return {'FINISHED'} 


#Setup Retopo Mesh
class SetupRetopoMesh(bpy.types.Operator):  
    bl_idname = "setup.retopomesh"  
    bl_label = "Setup Retopo Mesh"  
  
    def execute(self, context):
        bpy.ops.setup.retopo()
        bpy.context.object.show_x_ray = True
        bpy.context.space_data.show_occlude_wire = True
        return {'FINISHED'} 

#Double Threshold 0.001
class DoubleThreshold0001(bpy.types.Operator):
    bl_idname = "double.threshold0001"
    bl_label = "Double Threshold 0001"

    @classmethod
    def poll(cls, context):
        return context.active_object is not None
    def execute(self, context):
        bpy.context.scene.tool_settings.double_threshold = 0.001
        return {'FINISHED'}

#Double Threshold 0.1
class DoubleThreshold01(bpy.types.Operator):
    bl_idname = "double.threshold01"
    bl_label = "Double Threshold 01"

    @classmethod
    def poll(cls, context):
        return context.active_object is not None
    def execute(self, context):
        bpy.context.scene.tool_settings.double_threshold = 0.1
        return {'FINISHED'}

#LapRelax
class LapRelax(bpy.types.Operator):
	bl_idname = "mesh.laprelax"
	bl_label = "LapRelax"
	bl_description = "Smoothing mesh keeping volume"
	bl_options = {'REGISTER', 'UNDO'}
	
	Repeat = bpy.props.IntProperty(
		name = "Repeat", 
		description = "Repeat how many times",
		default = 1,
		min = 1,
		max = 100)


	@classmethod
	def poll(cls, context):
		obj = context.active_object
		return (obj and obj.type == 'MESH' and context.mode == 'EDIT_MESH')

	def invoke(self, context, event):
		
		# smooth #Repeat times
		for i in range(self.Repeat):
			self.do_laprelax()
		
		return {'FINISHED'}


	def do_laprelax(self):
	
		context = bpy.context
		region = context.region  
		area = context.area
		selobj = bpy.context.active_object
		mesh = selobj.data
		bm = bmesh.from_edit_mesh(mesh)
		bmprev = bm.copy()
	
		for v in bmprev.verts:
			if v.select:
				tot = Vector((0, 0, 0))
				cnt = 0
				for e in v.link_edges:
					for f in e.link_faces:
						if not(f.select):
							cnt = 1
					if len(e.link_faces) == 1:
						cnt = 1
						break
				if cnt:
					# dont affect border edges: they cause shrinkage
					continue
					
				# find Laplacian mean
				for e in v.link_edges:
					tot += e.other_vert(v).co
				tot /= len(v.link_edges)
				
				# cancel movement in direction of vertex normal
				delta = (tot - v.co)
				if delta.length != 0:
					ang = delta.angle(v.normal)
					deltanor = math.cos(ang) * delta.length
					nor = v.normal
					nor.length = abs(deltanor)
					bm.verts[v.index].co = tot + nor
			
			
		mesh.update()
		bm.free()
		bmprev.free()
		bpy.ops.object.editmode_toggle()
		bpy.ops.object.editmode_toggle()

#Wire on all objects
class Wire_All(bpy.types.Operator):
    """Tooltip"""
    bl_idname = "object.wire_all"
    bl_label = "Wire on All Objects"

    @classmethod
    def poll(cls, context):
        return context.active_object is not None

    def execute(self, context):
        
        for obj in bpy.data.objects:
            if obj.show_wire:
                obj.show_all_edges = False
                obj.show_wire = False
            
            else:
                obj.show_all_edges = True
                obj.show_wire = True
               
                
        return {'FINISHED'}

#Align to X
class AlignToX(bpy.types.Operator):  
    bl_idname = "object.align2x"  
    bl_label = "Align To X"  
  
    def execute(self, context):
        bpy.ops.object.mode_set(mode = 'OBJECT')
        bpy.ops.object.transform_apply(location=True, rotation=True, scale=True)

        for vert in bpy.context.object.data.vertices:
            if vert.select: 
                vert.co[0] = 0
        bpy.ops.object.editmode_toggle() 
        return {'FINISHED'} 

#################### Panel
  
class RetopologyTools(bpy.types.Panel): 
    
    bl_label = "Retopology Tools"
    bl_space_type = 'VIEW_3D'
    bl_region_type = 'TOOLS'
    bl_category = "Retopology"
  
    def draw(self, context): 
        layout = self.layout 
        
        #Tools
        layout.label(text="Tools :")
        
        row = layout.row()
        row.operator("setup.retopomesh", icon = 'UV_FACESEL')
        row = layout.row()
        row.operator("gpencil.surfsk_add_surface", text="Add Bsurface", icon = 'MOD_DYNAMICPAINT')
        row = layout.row()
        row.operator("shrink.update", icon = 'MOD_SHRINKWRAP')
        row = layout.row()
        row.operator("polysculpt.retopo", text = "Sculpt Mesh", icon = 'SCULPTMODE_HLT')
        split = layout.split()
        split = layout.split()
        row = layout.row()
        row.operator("mesh.laprelax", icon = 'MOD_LATTICE')
        row = layout.row()
        row.operator("object.automirror", icon = 'MOD_MIRROR')
        row = layout.row()
        row.operator("object.align2x", icon='MOD_WIREFRAME')
        row = layout.row()
        row.operator("mesh.gstretch", text="GStretch", icon='GREASEPENCIL')
        
        split = layout.split()
        split = layout.split()
        row = layout.row()
        row.operator("mesh.flip_normals", icon = 'FULLSCREEN_ENTER')
        row = layout.row()
        row.operator("mesh.normals_make_consistent", icon = 'MATCUBE')
        row = layout.row()
        row.operator("mesh.remove_doubles",icon='X_VEC')
        
        row = layout.row()
        #Shading
        layout.label(text="Modifiers :")
        row = layout.row()
        row.operator("object.modifier_apply", text="Apply Subsurf", icon='MOD_SUBSURF').modifier="Subsurf"
        row.operator("object.modifier_apply", text="Apply Mirror", icon='MOD_MIRROR').modifier="Mirror"
        
        row = layout.row()
        row.operator("object.modifier_remove", text="Del Subsurf", icon='MOD_SUBSURF').modifier="Subsurf"
        row.operator("object.modifier_remove", text="Del Mirror", icon='MOD_MIRROR').modifier="Mirror"

        #Shading
        layout.label(text="Shading :")
        row = layout.row()
        row.operator("wm.context_toggle", text="Xray", icon='META_CUBE').data_path = "object.show_x_ray"
        row.operator("wm.context_toggle", text="HIWR", icon='GHOST_ENABLED').data_path = "space_data.show_occlude_wire"
        row.operator("wm.context_toggle", text="L2V", icon='ORTHO').data_path = "space_data.use_occlude_geometry"
        row = layout.row()
        
        row.operator("object.wire_all", text="Wire All", icon='WIRE')
        row.operator("object.wire_selected", text="Wire Selected", icon='WIRE')
        row = layout.row()
        row.operator("mesh.faces_shade_smooth", text= "Smooth", icon = 'ANTIALIASED')
        row.operator("mesh.faces_shade_flat", text= "Flat", icon = 'ALIASED')
        
        row = layout.row()
        view = context.space_data
        obj = context.object
        col = layout.column()
        col.prop(view, "show_backface_culling")
        
        row.operator("wm.context_toggle", text="DB Sided", icon='MESH_DATA').data_path = "object.data.show_double_sided"
        row.operator("wm.context_toggle", text="Auto Smooth", icon='MESH_DATA').data_path = "object.data.use_auto_smooth"

        
        #Properties
        layout.label(text="Properties :")
        
        col = layout.column()
        Automerge = context.tool_settings
        col.prop(Automerge, "use_mesh_automerge", text = "Auto Merge")
        
        
        row = layout.row()
        row.operator("double.threshold01", text= "TSHD 0.1")
        row.operator("double.threshold0001", text= "TSHD 0.001")
        
        tool_settings = context.tool_settings
        row = layout.row()
        col.label("Double Threshold:")
        col.prop(tool_settings, "double_threshold", text="")
        col = layout.column(align=True)
        
        
  
def register(): 
    bpy.utils.register_class(RetopologyTools)
    bpy.utils.register_class(AlignToX)
    bpy.utils.register_class(Wire_All)
    bpy.utils.register_class(LapRelax)
    bpy.utils.register_class(DoubleThreshold01)
    bpy.utils.register_class(DoubleThreshold0001)
    bpy.utils.register_class(SetupRetopoMesh)
    bpy.utils.register_class(MeshGstretch)
    
    
    
    
def unregister(): 
    bpy.utils.unregister_class(RetopologyTools) 
    bpy.utils.unregister_class(AlignToX)
    bpy.utils.unregister_class(Wire_All)
    bpy.utils.unregister_class(LapRelax)
    bpy.utils.unregister_class(DoubleThreshold01)
    bpy.utils.unregister_class(DoubleThreshold0001)
    bpy.utils.unregister_class(SetupRetopoMesh)
    bpy.utils.unregister_class(MeshGstretch)
    
if __name__ == "__main__": 
    register() 









